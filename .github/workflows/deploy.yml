name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
    paths:
      - 'backend-spring/**'
      - 'llm-service/**'
      - 'docker-compose.yml'
      - 'nginx.conf'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Manual trigger for disaster recovery

env:
  APP_DIR: /opt/freshbite
  REPO_URL: https://github.com/${{ github.repository }}.git

jobs:
  # â”€â”€ Step 1: Quick backend sanity checks â”€â”€
  check-spring:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend-spring
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
      - run: chmod +x mvnw
      - run: ./mvnw package -DskipTests -q

  check-fastapi:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: llm-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - run: python -c "import main; print('FastAPI OK')"

  # â”€â”€ Step 2: Deploy (only after backend checks pass) â”€â”€
  deploy:
    needs: [check-spring, check-fastapi]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ðŸš€ Bootstrap & Deploy to Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          command_timeout: 12m
          script: |
            set -euo pipefail

            APP_DIR="/opt/freshbite"

            # â”€â”€ 1. Ensure Docker is installed (idempotent) â”€â”€
            if ! command -v docker &> /dev/null; then
              echo "ðŸ“¦ Installing Docker..."
              apt-get update -qq
              apt-get install -y -qq curl git
              curl -fsSL https://get.docker.com | sh
            fi

            if ! command -v docker compose &> /dev/null && ! command -v docker-compose &> /dev/null; then
              echo "ðŸ“¦ Installing Docker Compose plugin..."
              apt-get install -y -qq docker-compose-plugin
            fi

            # Determine compose command
            if docker compose version &> /dev/null; then
              COMPOSE="docker compose"
            else
              COMPOSE="docker-compose"
            fi

            # â”€â”€ 2. Clone or pull repo â”€â”€
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "ðŸ“¥ Cloning repository..."
              mkdir -p "$APP_DIR"
              git clone ${{ env.REPO_URL }} "$APP_DIR"
            else
              echo "ðŸ“¥ Pulling latest changes..."
              cd "$APP_DIR"
              git fetch origin main
              git reset --hard origin/main
            fi

            cd "$APP_DIR"

            # â”€â”€ 3. Write .env.prod (secrets from GitHub, never in repo) â”€â”€
            cat > .env.prod << 'ENVEOF'
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            WEB_ORIGIN=${{ secrets.WEB_ORIGIN }}
            ENVEOF

            # Remove leading whitespace from heredoc
            sed -i 's/^[[:space:]]*//' .env.prod

            chmod 600 .env.prod

            # â”€â”€ 4. Build & deploy â”€â”€
            echo "ðŸ”¨ Building and deploying containers..."
            $COMPOSE down --remove-orphans 2>/dev/null || true
            $COMPOSE build --no-cache
            $COMPOSE up -d

            # â”€â”€ 5. Wait for health checks â”€â”€
            echo "â³ Waiting for services to become healthy..."
            RETRIES=0
            MAX_RETRIES=20
            until [ "$RETRIES" -ge "$MAX_RETRIES" ]; do
              if curl -sf http://localhost/health > /dev/null 2>&1; then
                echo "âœ… Health check passed!"
                break
              fi
              RETRIES=$((RETRIES + 1))
              echo "   Attempt $RETRIES/$MAX_RETRIES â€” waiting 5s..."
              sleep 5
            done

            if [ "$RETRIES" -ge "$MAX_RETRIES" ]; then
              echo "âŒ Health check failed after $MAX_RETRIES attempts"
              echo "â”€â”€ Container status â”€â”€"
              $COMPOSE ps
              echo "â”€â”€ Spring Boot logs â”€â”€"
              $COMPOSE logs --tail=30 spring-boot
              echo "â”€â”€ LLM logs â”€â”€"
              $COMPOSE logs --tail=15 llm-service
              exit 1
            fi

            # â”€â”€ 6. Cleanup â”€â”€
            docker image prune -f > /dev/null 2>&1
            echo ""
            echo "â”€â”€ Running containers â”€â”€"
            $COMPOSE ps
            echo ""
            echo "ðŸŽ‰ Deployment successful!"
